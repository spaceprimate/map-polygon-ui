<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset=utf-8>
    <meta content="IE=edge" http-equiv=X-UA-Compatible>
    <meta content="width=device-width,initial-scale=1" name=viewport>
    <title>Map Polygon UI</title>

    <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.4/css/ol.css" type="text/css">

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script> -->

    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.4/build/ol-debug.js"></script>
</head>

<body id="top" style="margin-bottom:80px;">
    <nav class="navbar navbar-inverse navbar-user">
        <div class="container-fluid">
            <div class="navbar-left user-info">Map Polygon Input Generation</div>
        </div>
    </nav>

    
        <div class="container">

            
            <div class="row">
                <div class="col-sm-6 col-sm-offset-3" id="registrationForm">
                    <div class="form-wrapper" style="padding-top:12px;">
                        <form>

                            <p>Please draw a polygon on the map or enter coordinates manually below</p>

                            <div id="map" class="map" style="margin-bottom:12px;"></div>
                            <div>
                                <p><button class="btn btn-info submit btn-small" id="display-manual-coordinates">Enter Coordinates Manually</button></p>
                            </div>
                            <div id="map-points" style="display:none;">
                                <p>
                                    <a href="#" id="clear-map-points" class="pull-right">clear</a>
                                    Points
                                </p>
                                <div id="map-point-values"></div>
                            </div>

                           

                        </form>
                    </div>
                </div>
            </div>
        </div>
    


    <script>
        //NRL's bluemarble basemap layer from WMS service
        var wmsTiles = new ol.layer.Tile({
            source: new ol.source.TileWMS({
                url: 'https://geoint.nrlssc.navy.mil/nrltileserver/wms',
                params: {
                    'LAYERS': 'bluemarble',
                    'TILED': true
                },
                serverType: 'geoserver'
            })
        });

        var source = new ol.source.Vector({
            wrapX: false
        });

        var vector = new ol.layer.Vector({
            source: source
        });

        var map = new ol.Map({
            layers: [wmsTiles, vector],
            target: 'map',
            view: new ol.View({
                center: [-11000000, 4600000],
                zoom: 4
            })
        });

        var typeSelect = document.getElementById('type');

        var draw; // global so we can remove it later
        function addInteraction() {
            // var value = typeSelect.value;
            // if (value !== 'None') {
                draw = new ol.interaction.Draw({
                    source: source,
                    // type: typeSelect.value,
                    type: 'Polygon'
                });
                map.addInteraction(draw);
            // }
        }



/*

var ring = [[-12073459.720221292,4424140.860199702],
[-11022948.616312541,5297122.785766149],
[-11267507.693982394, 3845205.61363921],
[-12073459.720221292, 4424140.860199702]];

var polygon = new ol.geom.Polygon([ring]);

// Create feature with polygon.
var feature = new ol.Feature(polygon);


vector.getSource().addFeature(feature)










// Create vector source and the feature to it.
var vectorSource = new ol.source.Vector();
vectorSource.addFeature(feature);

// Create vector layer attached to the vector source.
var vectorLayer = new ol.layer.Vector({
  source: vectorSource
});

// Add the vector layer to the map.
map.addLayer(vectorLayer);



*/
        
        // add programatically
        // https://stackoverflow.com/questions/27210362/open-layers-3-how-to-draw-a-polygon-programmically
        // you might need to transform projection of polygon

        addInteraction();

        /**
         * Populate coordinate inputs fields on drawend
         */
        draw.on('drawend', function (e) {
            var feature = e.feature;
            var geometry = feature.getGeometry();
            var coordinates = geometry.getCoordinates()[0];
            $("#map-point-values").html(""); //remove previous values
            $("#map-points").show();
            coordinates.forEach(function (coords, index) {
                addPointField(index, coords[0], coords[1]);
            });
        });
        
        /**
         * Remove existing polygons on drawstart
         */
        draw.on('drawstart', function () {
            source.clear();
        });
        
        /**
         * Appends a html block with coordinate information for each point
         */
        function addPointField(id, lat, lon) {
            var pointNumber = id + 1;
            var input =
                '<div class="form-inline form-group" style="border-bottom: 1px solid #e7e7e7; padding-bottom: 8px; margin-bottom: 8px;">' +
                '<b>' + pointNumber + '</b> - ' +
                '<label for="rq-coord-1-lat" class="col-form-label control-label">Lat: </label>' +
                '<input value="' + lat + '"  type="number" id="rq-coord-' + id + '-lat" name="coord-' + id +
                '-lat" maxlength="64" required style="width: 160px; min-width: 140px; font-size: 14px; margin-left: 3px; margin-right: 8px;" placeholder="latitude"> ' +
                '<label for="rq-coord-1-lon" class="col-form-label control-label">Lon: </label>' +
                '<input value="' + lon + '"  type="number" id="rq-coord-' + id + '-lon" name="coord-' + id +
                '-lon" maxlength="64" required style="width: 160px; min-width: 140px; font-size: 14px; margin-left: 3px; margin-right: 8px;" placeholder="latitude">' +
                '</div>';
            $("#map-point-values").append(input);
        }

        function displayManualCoordinates(){
            source.clear();
            $("#map-point-values").html(""); //remove previous values
            for(i=0; i<3; i++){
                addPointField(i, 0, 0);
            }
            $("#map-points").show();
        }

        function updatePolygon(){
            var points = getPolygonInputs();
            source.clear();

            var polygon = new ol.geom.Polygon([points]);

            // Create feature with polygon.
            var feature = new ol.Feature(polygon);


            vector.getSource().addFeature(feature)
            


        }

        function getPolygonInputs(){
            var newPoly = [];
            //var coordPair = [0,0];
            $("#map-point-values input").each(function(i){

                if(!isOdd(i)){
                    newPoly.push([$(this).val(),0]);
                }
                else{
                    newPoly[newPoly.length - 1][1] = $(this).val();
                }


            });
            console.log(newPoly);
            return newPoly;
        }

        function isOdd(num) { return num % 2;}




        /* -- Controls --------------------------------------- */

        // handle "clear" button
        $(document).ready(function () {
            $("#clear-map-points").on("click", function (event) {
                event.preventDefault();
                $("#map-point-values").html("");
                $("#map-points").hide();
                source.clear();
            });

            $("#display-manual-coordinates").on("click", function (event) {
                event.preventDefault();
                displayManualCoordinates();
            });

            $("#map-point-values").on("change", "input", function(event){
                updatePolygon();
                console.log("input value changed");
            });

        });
    </script>
</body>

</html>